
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Two-Level Model with Sequential Observations &#8212; BayesFlow: Amortized Bayesian Inference</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=8fec244e" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_examples/Two_Level_Sequential_Model';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.16.1';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = '/versions.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = 'stable-legacy';
        DOCUMENTATION_OPTIONS.show_version_warning_banner =
            false;
        </script>
    <link rel="canonical" href="https://www.bayesflow.org/_examples/Two_Level_Sequential_Model.html" />
    <link rel="icon" href="../_static/bayesflow_hex.ico"/>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class=" navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/bayesflow_hor.png" class="logo__image only-light" alt="BayesFlow: Amortized Bayesian Inference - Home"/>
    <img src="../_static/bayesflow_hor_dark.png" class="logo__image only-dark pst-js-only" alt="BayesFlow: Amortized Bayesian Inference - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class=" navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../index.html">
    BayesFlow
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../examples.html">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api/bayesflow.html">
    Public API: bayesflow package
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../installation.html">
    Full Installation Instructions
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../about.html">
    About us
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/bayesflow-org/bayesflow" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://discuss.bayesflow.org/" title="Discourse Forum" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-discourse fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Discourse Forum</span></a>
        </li>
</ul></div>
      
        <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-2"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-2"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-2"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-2">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../index.html">
    BayesFlow
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../examples.html">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api/bayesflow.html">
    Public API: bayesflow package
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../installation.html">
    Full Installation Instructions
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../about.html">
    About us
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/bayesflow-org/bayesflow" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://discuss.bayesflow.org/" title="Discourse Forum" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-discourse fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Discourse Forum</span></a>
        </li>
</ul></div>
        
          <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-3"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-3"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-3"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-3">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Two-Level Model with Sequential Observations</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="two-level-model-with-sequential-observations">
<h1>Two-Level Model with Sequential Observations<a class="headerlink" href="#two-level-model-with-sequential-observations" title="Link to this heading">#</a></h1>
<p>by Noah Giles</p>
<section id="table-of-contents">
<h2>Table of contents<a class="headerlink" href="#table-of-contents" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="#toc1_1_"><span class="xref myst">Two Level Priors</span></a></p></li>
<li><p><a class="reference internal" href="#toc1_2_"><span class="xref myst">Two Level Model</span></a></p>
<ul>
<li><p><a class="reference internal" href="#toc1_2_1_"><span class="xref myst">Simulated Local Walks</span></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#toc1_3_"><span class="xref myst">Networks and Amortizer</span></a></p>
<ul>
<li><p><a class="reference internal" href="#toc1_3_1_"><span class="xref myst">Summary Network</span></a></p></li>
<li><p><a class="reference internal" href="#toc1_3_2_"><span class="xref myst">Amortizers</span></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#toc1_4_"><span class="xref myst">Training</span></a></p></li>
<li><p><a class="reference internal" href="#toc1_5_"><span class="xref myst">Validation</span></a></p>
<ul>
<li><p><a class="reference internal" href="#toc1_5_1_"><span class="xref myst">Latent Dims</span></a></p></li>
<li><p><a class="reference internal" href="#calibration"><span class="xref myst">Checking Calibration</span></a></p></li>
<li><p><a class="reference internal" href="#toc1_5_2_"><span class="xref myst">Parameter Recovery in Example Dataset</span></a></p></li>
<li><p><a class="reference internal" href="#toc1_5_3_"><span class="xref myst">Recoveries in the Aggregate</span></a></p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">bayesflow</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">bf</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tensorflow</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tf</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-01-27 20:15:19.441826: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2025-01-27 20:15:19.459100: E external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:9261] Unable to register cuDNN factory: Attempting to register factory for plugin cuDNN when one has already been registered
2025-01-27 20:15:19.459121: E external/local_xla/xla/stream_executor/cuda/cuda_fft.cc:607] Unable to register cuFFT factory: Attempting to register factory for plugin cuFFT when one has already been registered
2025-01-27 20:15:19.459673: E external/local_xla/xla/stream_executor/cuda/cuda_blas.cc:1515] Unable to register cuBLAS factory: Attempting to register factory for plugin cuBLAS when one has already been registered
2025-01-27 20:15:19.463223: I tensorflow/core/platform/cpu_feature_guard.cc:182] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 AVX_VNNI FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
2025-01-27 20:15:19.876290: W tensorflow/compiler/tf2tensorrt/utils/py_utils.cc:38] TF-TRT Warning: Could not find TensorRT
/home/noah/.miniforge3/envs/bayesflow-example/lib/python3.11/site-packages/bayesflow/trainers.py:27: TqdmExperimentalWarning: Using `tqdm.autonotebook.tqdm` in notebook mode. Use `tqdm.tqdm` instead to force console mode (e.g. in jupyter console)
  from tqdm.autonotebook import tqdm
</pre></div>
</div>
</div>
</div>
<p>This notebook demonstrates the components required for performing Bayesian inference in a two-level hierarchical model, focusing on cases where group-level observations are ordered and thus non-exchangeable. As a contrived example, we use a model that consists of multiple random walks, each governed by a shared population distribution.</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
    \mu_{\text{pop}} &amp;\sim \mathcal{N}(0, 1) &amp;&amp; \text{(Population mean)} \\
    \mu_i &amp;\sim \mathcal{N}(\mu_{\text{pop}}, \sigma=0.25) &amp;&amp; \text{(Subgroup mean for group } i\text{)} \\
    x_{i,t} &amp;\sim \mathcal{N}(x_{i,t-1} + \mu_i, 1) &amp;&amp; \text{(Random walk with subgroup mean)}
\end{align*}
\end{split}\]</div>
<p>The goal is thus to infer the posterior distributions of <span class="math notranslate nohighlight">\(\mu_i\)</span> and <span class="math notranslate nohighlight">\(\mu_{\text{pop}}\)</span> from observations <span class="math notranslate nohighlight">\(x_{i,t}\)</span>.</p>
</section>
<section id="two-level-priors">
<h2><a id='toc1_1_'></a>Two Level Priors<a class="headerlink" href="#two-level-priors" title="Link to this heading">#</a></h2>
<p>The structure of our prior functions follows the hierarchical nature of the model. First, we define a hyper-prior function <code class="docutils literal notranslate"><span class="pre">hyper_prior_fun</span></code>, which samples population-level parameters. Then, a local prior function is specified, which takes these hyperparameters as inputs. To encode this into the framework, these functions are provided to a <code class="docutils literal notranslate"><span class="pre">TwoLevelPrior</span></code> object, in contrast to single-level models. Note that here, the local prior function returns parameters in an array of shape <code class="docutils literal notranslate"><span class="pre">(n_groups,</span> <span class="pre">n_params)</span></code>.</p>
<p>Also note that, if applicable, parameters shared across subgroups can additionally be implemented via a “shared prior” function, which can be provided as a third argument to the prior object.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N_TIMSTEPS</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">N_GROUPS</span> <span class="o">=</span> <span class="mi">6</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">hyper_prior_fun</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">local_prior_fun</span><span class="p">(</span><span class="n">hyper_params</span><span class="p">):</span>
    <span class="n">mu_0</span> <span class="o">=</span> <span class="n">hyper_params</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu_0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">N_GROUPS</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mu</span>


<span class="n">prior</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">TwoLevelPrior</span><span class="p">(</span>
    <span class="n">local_prior_fun</span><span class="o">=</span><span class="n">local_prior_fun</span><span class="p">,</span> <span class="n">hyper_prior_fun</span><span class="o">=</span><span class="n">hyper_prior_fun</span>
<span class="p">)</span>
<span class="n">prior</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;hyper_parameters&#39;: array([[0.49671414],
        [0.7674347 ]], dtype=float32),
 &#39;local_parameters&#39;: array([[[0.46214807],
         [0.6586363 ],
         [0.8774716 ],
         [0.4381758 ],
         [0.4381799 ],
         [0.89151734]],
 
        [[0.65006614],
         [0.90307474],
         [0.6515803 ],
         [0.6510023 ],
         [0.82792526],
         [0.28911465]]], dtype=float32),
 &#39;batchable_context&#39;: None,
 &#39;non_batchable_context&#39;: None}
</pre></div>
</div>
</div>
</div>
</section>
<section id="two-level-model">
<h2><a id='toc1_2_'></a>Two Level Model<a class="headerlink" href="#two-level-model" title="Link to this heading">#</a></h2>
<p>In similar fashion to the definition of our prior, here we make use of the dedicated <code class="docutils literal notranslate"><span class="pre">TwoLevelGenerativeModel</span></code> class for the purposes of implementing our simulation. Since this simulation function is not batched, we receive params in the shape <code class="docutils literal notranslate"><span class="pre">(n_groups,</span> <span class="pre">n_params)</span></code>, and return data in the shape <code class="docutils literal notranslate"><span class="pre">(n_groups,</span> <span class="pre">n_observations,</span> <span class="pre">n_dims)</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">simulate</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">params</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">N_GROUPS</span><span class="p">,</span> <span class="n">N_TIMSTEPS</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">N_GROUPS</span><span class="p">,</span> <span class="n">N_TIMSTEPS</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="p">)</span>


<span class="n">model</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">TwoLevelGenerativeModel</span><span class="p">(</span>
    <span class="n">prior</span><span class="p">,</span> <span class="n">simulator</span><span class="o">=</span><span class="n">simulate</span><span class="p">,</span> <span class="n">simulator_is_batched</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
<span class="n">model</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:root:Performing 2 pilot runs with the anonymous model...
INFO:root:Shape of parameter batch after 2 pilot simulations: (batch_size = 2, 6, 1)
INFO:root:Shape of simulation batch after 2 pilot simulations: (batch_size = 2, 6, 40, 1)
INFO:root:Shape of hyper_prior_draws batch after 2 pilot simulations: (batch_size = 2, 1)
INFO:root:Shape of local_prior_draws batch after 2 pilot simulations: (batch_size = 2, 6, 1)
INFO:root:No shared_prior_draws provided.
INFO:root:No optional simulation batchable context provided.
INFO:root:No optional simulation non-batchable context provided.
INFO:root:No optional prior batchable context provided.
INFO:root:No optional prior non-batchable context provided.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;sim_data&#39;: array([[[[  0.59617533],
          [  0.93787662],
          [ -0.19889452],
          [ -0.25877812],
          [  0.33339311],
          [ -1.49522807],
          [ -1.11108377],
          [ -1.93292343],
          [ -1.52154066],
          [ -2.44401571],
          [ -4.40811371],
          [ -6.19487204],
          [ -6.306003  ],
          [ -6.20549639],
          [ -7.26902891],
          [ -6.78965235],
          [ -8.61038831],
          [ -8.83568401],
          [-10.2059161 ],
          [-11.01696811],
          [-11.12878534],
          [-12.1484146 ],
          [-12.69218604],
          [-11.84510913],
          [-12.58121689],
          [-11.90474068],
          [-13.19366343],
          [-12.82307515],
          [-11.54072243],
          [-14.17158283],
          [-15.12769398],
          [-14.70983775],
          [-15.07209903],
          [-14.86016906],
          [-15.62337014],
          [-15.69599625],
          [-16.01088938],
          [-15.00232322],
          [-14.90711827],
          [-14.72873151]],
 
         [[ -0.29574113],
          [ -0.66721152],
          [ -0.98363387],
          [ -0.47304589],
          [ -0.77789454],
          [ -0.37198385],
          [  1.81955279],
          [  2.80681333],
          [  2.59692563],
          [  3.91427539],
          [  3.62233585],
          [  1.70034715],
          [  0.80839668],
          [ -0.94625941],
          [ -1.18163706],
          [ -1.04708284],
          [  0.74549031],
          [  1.18855352],
          [  1.08558882],
          [  2.03113024],
          [ -0.06386923],
          [  0.28788116],
          [  1.17488219],
          [ -0.18756822],
          [  1.07232166],
          [  1.5269539 ],
          [  1.22780182],
          [  1.97671952],
          [  4.36354822],
          [  4.66155031],
          [  5.02590673],
          [  4.68268167],
          [  3.94897313],
          [  4.89544478],
          [  4.15549679],
          [  4.34319887],
          [  3.98167726],
          [  4.57679292],
          [  5.02659086],
          [  6.18026664]],
 
         [[ -0.4740543 ],
          [ -0.70796713],
          [ -1.65076875],
          [ -2.05909991],
          [ -1.64583731],
          [ -0.85288659],
          [ -1.73908982],
          [ -0.8335218 ],
          [  0.55807816],
          [  1.00747517],
          [  2.92023308],
          [  2.18240598],
          [  0.97371338],
          [ -0.76904477],
          [  0.76296165],
          [  1.4532894 ],
          [  1.43366683],
          [  1.74959756],
          [  0.66007062],
          [  3.1417847 ],
          [  3.30696798],
          [  3.45232487],
          [  4.2140536 ],
          [  4.73102493],
          [  4.99087106],
          [  4.2363587 ],
          [  4.74378916],
          [  6.66177576],
          [  8.04315791],
          [  9.67230663],
          [  9.19705306],
          [  8.24341034],
          [  8.15358552],
          [  8.24527253],
          [  9.37542615],
          [  7.71892362],
          [  9.28443605],
          [  9.16239025],
          [  8.77147128],
          [  7.795329  ]],
 
         [[ -1.66607206],
          [ -0.85411686],
          [ -0.79201428],
          [ -2.09319056],
          [ -3.39948472],
          [ -3.7464848 ],
          [ -2.08867866],
          [ -2.3594854 ],
          [ -3.87384374],
          [ -4.13080219],
          [ -4.41474114],
          [ -7.12284317],
          [ -7.18835342],
          [ -7.43050334],
          [ -6.74551236],
          [ -4.90777165],
          [ -3.792422  ],
          [ -4.07252608],
          [ -5.19026737],
          [ -2.62812295],
          [ -2.5801199 ],
          [ -2.577406  ],
          [ -2.61274647],
          [ -2.42587709],
          [ -2.58145289],
          [ -3.16633028],
          [ -3.72440461],
          [ -3.76837326],
          [ -4.32301342],
          [ -5.04707459],
          [ -4.95185974],
          [ -5.21805235],
          [ -3.72527474],
          [ -6.38745994],
          [ -5.30716847],
          [ -4.07229866],
          [ -6.15690428],
          [ -6.51080726],
          [ -6.89346351],
          [ -8.31219059]],
 
         [[ -0.95618597],
          [ -2.2451311 ],
          [ -0.67122994],
          [  0.08607917],
          [  1.17926498],
          [  1.72256776],
          [  0.41514671],
          [ -0.28774284],
          [  0.02326243],
          [ -1.37723466],
          [ -0.84260551],
          [ -1.26130019],
          [ -1.81449029],
          [ -1.2818996 ],
          [ -1.01600557],
          [ -1.55534102],
          [ -0.5743805 ],
          [ -1.83381311],
          [ -1.39624679],
          [ -0.98151482],
          [ -1.46943054],
          [ -1.3216668 ],
          [ -2.75114966],
          [ -2.00549193],
          [ -2.36876335],
          [ -3.06985565],
          [ -2.19921571],
          [ -3.08192868],
          [ -4.66875926],
          [ -6.40375772],
          [ -5.97611705],
          [ -7.43491569],
          [ -5.85849079],
          [ -8.11878948],
          [ -6.6007024 ],
          [ -6.56805421],
          [ -6.84313661],
          [ -7.56642498],
          [ -7.34565815],
          [ -7.56166213]],
 
         [[  1.00763068],
          [  1.02618712],
          [  1.08081767],
          [  0.62153425],
          [  0.46891742],
          [  0.68104798],
          [ -1.12479161],
          [ -2.56864824],
          [ -1.92105536],
          [ -1.84586112],
          [ -2.12551567],
          [ -2.20275294],
          [ -1.95084244],
          [ -2.58627333],
          [ -3.46024926],
          [ -3.36007521],
          [ -4.4341192 ],
          [ -4.12153765],
          [ -5.91979246],
          [ -4.98630803],
          [ -4.60938175],
          [ -4.44902323],
          [ -3.56200345],
          [ -1.99220021],
          [ -1.07350135],
          [ -3.01004679],
          [ -4.38529496],
          [ -5.10578475],
          [ -5.1753649 ],
          [ -4.75337709],
          [ -5.57479211],
          [ -5.48369655],
          [ -6.33475069],
          [ -7.0419397 ],
          [ -8.54427201],
          [ -9.56317646],
          [-11.01053227],
          [-12.08207673],
          [-11.12410614],
          [-12.16917624]]]]),
 &#39;hyper_prior_draws&#39;: array([[0.04852163]], dtype=float32),
 &#39;local_prior_draws&#39;: array([[[-0.1592159 ],
         [ 0.11613584],
         [ 0.0359621 ],
         [-0.01121539],
         [-0.17836928],
         [-0.09567121]]], dtype=float32),
 &#39;shared_prior_draws&#39;: None,
 &#39;sim_batchable_context&#39;: None,
 &#39;sim_non_batchable_context&#39;: None,
 &#39;prior_batchable_context&#39;: None,
 &#39;prior_non_batchable_context&#39;: None}
</pre></div>
</div>
</div>
</div>
<section id="simulated-local-walks">
<h3><a id='toc1_2_1_'></a>Simulated Local Walks<a class="headerlink" href="#simulated-local-walks" title="Link to this heading">#</a></h3>
<p>Having defined our simulator function, below is an example of one of our generated datasets, which we will save for subsequent use.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_sim</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_GROUPS</span><span class="p">):</span>
    <span class="n">sim_data</span> <span class="o">=</span> <span class="n">test_sim</span><span class="p">[</span><span class="s2">&quot;sim_data&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N_TIMSTEPS</span><span class="p">),</span> <span class="n">sim_data</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Population of Simulated Walks&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/8c9d2ecdb7c144d341a279f0259f629ad773f56b76983edc2bbcb0d2691e0e7c.png" src="../_images/8c9d2ecdb7c144d341a279f0259f629ad773f56b76983edc2bbcb0d2691e0e7c.png" />
</div>
</div>
</section>
</section>
<section id="networks-and-amortizer">
<h2><a id='toc1_3_'></a>Networks and Amortizer<a class="headerlink" href="#networks-and-amortizer" title="Link to this heading">#</a></h2>
<section id="summary-network">
<h3><a id='toc1_3_1_'></a>Summary Network<a class="headerlink" href="#summary-network" title="Link to this heading">#</a></h3>
<p>Since our data follows a hierarchical structure, summaries must be aggregated “up” the hierarchy. We first define a local summary network, which processes individual subgroups, and then a population-level summary network, which consolidates these local summaries to characterize the overall population.</p>
<p>Because the observations within our local groups are ordered, we use a <code class="docutils literal notranslate"><span class="pre">SequenceNetwork</span></code> to ensure that the model respects the sequential nature of the data. Note that because the <code class="docutils literal notranslate"><span class="pre">SequenceNetwork</span></code> expects inputs of shape <code class="docutils literal notranslate"><span class="pre">(n_batches,</span> <span class="pre">n_observations,</span> <span class="pre">n_dims)</span></code>, we <a class="reference external" href="https://discuss.bayesflow.org/t/time-series-dimension-errors-in-hierarchicalnetwork/122/2">must wrap it</a> in a <code class="docutils literal notranslate"><span class="pre">TimeDistributed</span></code> layer so that it can correctly process our data, which will have shape <code class="docutils literal notranslate"><span class="pre">(n_batches,</span> <span class="pre">n_groups,</span> <span class="pre">n_observations,</span> <span class="pre">n_dims)</span></code>.</p>
<p>At the population level, subgroup summaries are permutation-invariant, allowing us to use a <code class="docutils literal notranslate"><span class="pre">DeepSet</span></code> for aggregation. Both summary networks are encapsulated within a HierarchicalNetwork, which automatically applies the appropriate network at each hierarchical level—starting with the lowest-level observations and propagating upwards.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seq_net</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">TimeDistributed</span><span class="p">(</span><span class="n">bf</span><span class="o">.</span><span class="n">networks</span><span class="o">.</span><span class="n">SequenceNetwork</span><span class="p">(</span><span class="n">summary_dim</span><span class="o">=</span><span class="mi">32</span><span class="p">))</span>
<span class="n">seq_net</span><span class="o">.</span><span class="n">build</span><span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">summary_net</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">summary_networks</span><span class="o">.</span><span class="n">HierarchicalNetwork</span><span class="p">(</span>
    <span class="p">[</span><span class="n">seq_net</span><span class="p">,</span> <span class="n">bf</span><span class="o">.</span><span class="n">summary_networks</span><span class="o">.</span><span class="n">DeepSet</span><span class="p">(</span><span class="n">summary_dim</span><span class="o">=</span><span class="mi">128</span><span class="p">)]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-01-27 20:15:20.430925: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:901] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2025-01-27 20:15:20.443491: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:901] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2025-01-27 20:15:20.445082: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:901] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2025-01-27 20:15:20.448380: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:901] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2025-01-27 20:15:20.449942: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:901] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2025-01-27 20:15:20.451187: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:901] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2025-01-27 20:15:20.535317: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:901] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2025-01-27 20:15:20.536344: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:901] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2025-01-27 20:15:20.537181: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:901] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2025-01-27 20:15:20.538502: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1929] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 13484 MB memory:  -&gt; device: 0, name: NVIDIA GeForce RTX 4080 SUPER, pci bus id: 0000:01:00.0, compute capability: 8.9
2025-01-27 20:15:20.809946: I external/local_tsl/tsl/platform/default/subprocess.cc:304] Start cannot spawn child process: No such file or directory
</pre></div>
</div>
</div>
</div>
</section>
<section id="amortizers">
<h3><a id='toc1_3_2_'></a>Amortizers<a class="headerlink" href="#amortizers" title="Link to this heading">#</a></h3>
<p>The amortization process follows the hierarchical structure of our model, mirroring the construction of the summary networks. We define a local amortizer, which is responsible for approximating the posterior of local parameters within subgroups, and a global amortizer which learns the posterior of global (i.e., hyper- and shared) parameters. These are in turn wrapped into a <code class="docutils literal notranslate"><span class="pre">TwoLevelAmortizedPosterior</span></code> which knows how to interface with hierarchical data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">local_amortizer</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">amortizers</span><span class="o">.</span><span class="n">AmortizedPosterior</span><span class="p">(</span>
    <span class="n">inference_net</span><span class="o">=</span><span class="n">bf</span><span class="o">.</span><span class="n">networks</span><span class="o">.</span><span class="n">InvertibleNetwork</span><span class="p">(</span><span class="n">num_params</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">global_amortizer</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">amortizers</span><span class="o">.</span><span class="n">AmortizedPosterior</span><span class="p">(</span>
    <span class="n">inference_net</span><span class="o">=</span><span class="n">bf</span><span class="o">.</span><span class="n">networks</span><span class="o">.</span><span class="n">InvertibleNetwork</span><span class="p">(</span>
        <span class="n">num_params</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">amortizer</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">amortizers</span><span class="o">.</span><span class="n">TwoLevelAmortizedPosterior</span><span class="p">(</span>
    <span class="n">local_amortizer</span><span class="o">=</span><span class="n">local_amortizer</span><span class="p">,</span>
    <span class="n">global_amortizer</span><span class="o">=</span><span class="n">global_amortizer</span><span class="p">,</span>
    <span class="n">summary_net</span><span class="o">=</span><span class="n">summary_net</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="training">
<h2><a id='toc1_4_'></a>Training<a class="headerlink" href="#training" title="Link to this heading">#</a></h2>
<p>When defining the configurator function, we must correctly handle both hyperparameters (global-level) and local parameters (subgroup-level). In this case, no special scaling or transformations are required, so they can be passed through directly. With these considerations in place, the training process proceeds straightforwardly.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">configure_inputs</span><span class="p">(</span><span class="n">forward_dict</span><span class="p">):</span>
    <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">out_dict</span><span class="p">[</span><span class="s2">&quot;hyper_parameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">forward_dict</span><span class="p">[</span><span class="s2">&quot;hyper_prior_draws&quot;</span><span class="p">]</span>
    <span class="n">out_dict</span><span class="p">[</span><span class="s2">&quot;local_parameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">forward_dict</span><span class="p">[</span><span class="s2">&quot;local_prior_draws&quot;</span><span class="p">]</span>

    <span class="n">out_dict</span><span class="p">[</span><span class="s2">&quot;sim_data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">forward_dict</span><span class="p">[</span><span class="s2">&quot;sim_data&quot;</span><span class="p">]</span>
    <span class="n">out_dict</span><span class="p">[</span><span class="s2">&quot;summary_conditions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">forward_dict</span><span class="p">[</span><span class="s2">&quot;sim_data&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
    <span class="p">)</span>  <span class="c1"># back-of-the hand scaling for observations</span>

    <span class="k">return</span> <span class="n">out_dict</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trainer</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">trainers</span><span class="o">.</span><span class="n">Trainer</span><span class="p">(</span>
    <span class="n">amortizer</span><span class="o">=</span><span class="n">amortizer</span><span class="p">,</span> <span class="n">generative_model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">configurator</span><span class="o">=</span><span class="n">configure_inputs</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:root:Performing a consistency check with provided components...
2025-01-27 20:15:21.210310: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:454] Loaded cuDNN version 8904
2025-01-27 20:15:21.241837: I external/local_tsl/tsl/platform/default/subprocess.cc:304] Start cannot spawn child process: No such file or directory
INFO:root:Done.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">history</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">train_online</span><span class="p">(</span>
    <span class="n">epochs</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
    <span class="n">iterations_per_epoch</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
    <span class="n">validation_sims</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:root:Generated 200 simulations for validation.
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "65f4946d893e4d138e14c93ea7e48087", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-01-27 20:15:34.869468: I external/local_xla/xla/service/service.cc:168] XLA service 0x7319d08ea000 initialized for platform CUDA (this does not guarantee that XLA will be used). Devices:
2025-01-27 20:15:34.869487: I external/local_xla/xla/service/service.cc:176]   StreamExecutor device (0): NVIDIA GeForce RTX 4080 SUPER, Compute Capability 8.9
2025-01-27 20:15:34.872044: I tensorflow/compiler/mlir/tensorflow/utils/dump_mlir_util.cc:269] disabling MLIR crash reproducer, set env var `MLIR_CRASH_REPRODUCER_DIRECTORY` to enable.
WARNING: All log messages before absl::InitializeLog() is called are written to STDERR
I0000 00:00:1738026934.920236   23012 device_compiler.h:186] Compiled cluster using XLA!  This line is logged at most once for the lifetime of the process.
INFO:root:Validation, Epoch: 1, Local.Loss: -0.575, Global.Loss: -0.594
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "49a9ab51ce2f4febb9375c7f36247f39", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:root:Validation, Epoch: 2, Local.Loss: -0.582, Global.Loss: -0.640
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "eb06167dae664cffbdc350555ee08938", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:root:Validation, Epoch: 3, Local.Loss: -0.612, Global.Loss: -0.710
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "a017dca4cb7a4b1183687fb316a5ccb0", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:root:Validation, Epoch: 4, Local.Loss: -0.613, Global.Loss: -0.717
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "25dce5d07b0342678b4673ab3c5bbdfe", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:root:Validation, Epoch: 5, Local.Loss: -0.611, Global.Loss: -0.683
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "8c1cf2088d814e67bc07efd64b0ae499", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:root:Validation, Epoch: 6, Local.Loss: -0.618, Global.Loss: -0.717
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "b12f2c7c29e24011b6cf3b200243be86", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:root:Validation, Epoch: 7, Local.Loss: -0.616, Global.Loss: -0.712
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "ffc479fc4f1c4974b3bca1048b41b1a7", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:root:Validation, Epoch: 8, Local.Loss: -0.622, Global.Loss: -0.741
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "4cdb09f8a78b42c299a6795741b4c9eb", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:root:Validation, Epoch: 9, Local.Loss: -0.619, Global.Loss: -0.752
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "32b7d005bda1493291a4ba2a5600d8c7", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:root:Validation, Epoch: 10, Local.Loss: -0.620, Global.Loss: -0.731
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "7b77b68b76784d8294314fa52d28f31f", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:root:Validation, Epoch: 11, Local.Loss: -0.619, Global.Loss: -0.745
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "91b863a58a1549798f41f471eb6ab2a6", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:root:Validation, Epoch: 12, Local.Loss: -0.621, Global.Loss: -0.753
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">plot_losses</span><span class="p">(</span>
    <span class="n">history</span><span class="p">[</span><span class="s2">&quot;train_losses&quot;</span><span class="p">],</span> <span class="n">history</span><span class="p">[</span><span class="s2">&quot;val_losses&quot;</span><span class="p">],</span> <span class="n">moving_average</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f2bcc3bdd0af161a6c51be69d492dc70082948ec51934bedff2ae7b1de7e64cc.png" src="../_images/f2bcc3bdd0af161a6c51be69d492dc70082948ec51934bedff2ae7b1de7e64cc.png" />
</div>
</div>
</section>
<section id="validation">
<h2><a id='toc1_5_'></a>Validation<a class="headerlink" href="#validation" title="Link to this heading">#</a></h2>
<section id="latent-dims">
<h3><a id='toc1_5_1_'></a>Latent Dims<a class="headerlink" href="#latent-dims" title="Link to this heading">#</a></h3>
<p>Having fit the nets, we can now check the quality of the fit. Since our amortizer operates on two levels, it returns two sets of samples from the latent space. We can inspect both of them to ensure that the latent dimensions follow the prescribed Gaussian structure.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_sims</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">configurator</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="mi">500</span><span class="p">))</span>
<span class="p">(</span><span class="n">z_samples_local</span><span class="p">,</span> <span class="n">log_det_j_local</span><span class="p">),</span> <span class="p">(</span><span class="n">z_samples_global</span><span class="p">,</span> <span class="n">log_det_j_global</span><span class="p">)</span> <span class="o">=</span> <span class="n">amortizer</span><span class="p">(</span>
    <span class="n">test_sims</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The latent dims in on the global level:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">plot_latent_space_2d</span><span class="p">(</span><span class="n">z_samples_global</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/c984bd4ba3239691de0ac0cbd7cbdc511f25866899ec15ca1336db3f98850097.png" src="../_images/c984bd4ba3239691de0ac0cbd7cbdc511f25866899ec15ca1336db3f98850097.png" />
</div>
</div>
<p>Latent dims at the local level:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">plot_latent_space_2d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">z_samples_local</span><span class="o">.</span><span class="n">numpy</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/760da3a94d1890f8f8a9ee13cce25287fb2db5ddfe1991633f55ba4f17d08eca.png" src="../_images/760da3a94d1890f8f8a9ee13cce25287fb2db5ddfe1991633f55ba4f17d08eca.png" />
</div>
</div>
</section>
<section id="checking-calibration">
<h3><a id='calibration'></a>Checking Calibration<a class="headerlink" href="#checking-calibration" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">global_samples</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">local_samples</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">test_sims</span><span class="p">[</span><span class="s2">&quot;hyper_parameters&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">sim</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">test_sims</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">posterior</span> <span class="o">=</span> <span class="n">amortizer</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">global_samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;global_samples&quot;</span><span class="p">])</span>
    <span class="n">local_samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;local_samples&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>We can check the reliability of the model via rank statistics histograms at the global and local levels (see: https://arxiv.org/abs/1804.06788):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">plot_sbc_histograms</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">global_samples</span><span class="p">),</span> <span class="n">test_sims</span><span class="p">[</span><span class="s2">&quot;hyper_parameters&quot;</span><span class="p">],</span> <span class="n">num_bins</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">param_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;$\mu_</span><span class="si">{pop}</span><span class="s2">$&quot;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:root:The ratio of simulations / posterior draws should be &gt; 20 for reliable variance reduction, but your ratio is 5.                    Confidence intervals might be unreliable!
</pre></div>
</div>
<img alt="../_images/7b0d2ccad3f5ada252c1c6173ed4094c6698dac2f31d5ff99dd92d758b310b78.png" src="../_images/7b0d2ccad3f5ada252c1c6173ed4094c6698dac2f31d5ff99dd92d758b310b78.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">plot_sbc_histograms</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">local_samples</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
    <span class="n">test_sims</span><span class="p">[</span><span class="s2">&quot;local_parameters&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span>
    <span class="n">num_bins</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">param_names</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;$\mu_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">$&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_GROUPS</span><span class="p">)],</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:root:The ratio of simulations / posterior draws should be &gt; 20 for reliable variance reduction, but your ratio is 5.                    Confidence intervals might be unreliable!
</pre></div>
</div>
<img alt="../_images/4fa36398e116f295334ba6de6e39470569de497d2e55cd3bf064d6924b0a5169.png" src="../_images/4fa36398e116f295334ba6de6e39470569de497d2e55cd3bf064d6924b0a5169.png" />
</div>
</div>
<p>Alternatively, we can check calibration via the Empirical CDF (see: https://arxiv.org/abs/2103.10522):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">plot_sbc_ecdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">global_samples</span><span class="p">),</span> <span class="n">test_sims</span><span class="p">[</span><span class="s2">&quot;hyper_parameters&quot;</span><span class="p">],</span> <span class="n">param_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;$\mu_</span><span class="si">{pop}</span><span class="s2">$&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/6a206573f2fa4df5fdd1c75ff2265ab28339339dbb7dd6595a98c602eeff83dd.png" src="../_images/6a206573f2fa4df5fdd1c75ff2265ab28339339dbb7dd6595a98c602eeff83dd.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">plot_sbc_ecdf</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">local_samples</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
    <span class="n">test_sims</span><span class="p">[</span><span class="s2">&quot;local_parameters&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span>
    <span class="n">param_names</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;$\mu_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">$&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_GROUPS</span><span class="p">)],</span>
    <span class="n">n_row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">n_col</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/a4179bebfcf057217d5aa7daa55ebe811f78bf527807658e0e1f4280b8f4b2c8.png" src="../_images/a4179bebfcf057217d5aa7daa55ebe811f78bf527807658e0e1f4280b8f4b2c8.png" />
</div>
</div>
</section>
<section id="parameter-recovery-in-example-dataset">
<h3><a id='toc1_5_2_'></a>Parameter Recovery in Example Dataset<a class="headerlink" href="#parameter-recovery-in-example-dataset" title="Link to this heading">#</a></h3>
<p>We can additionally check how well the model recovered the parameters of our initial example dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N_POSTERIOR_SAMPLES</span> <span class="o">=</span> <span class="mi">4_000</span>

<span class="n">posterior_samples</span> <span class="o">=</span> <span class="n">amortizer</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
    <span class="n">trainer</span><span class="o">.</span><span class="n">configurator</span><span class="p">(</span><span class="n">test_sim</span><span class="p">),</span> <span class="n">N_POSTERIOR_SAMPLES</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>At a global level:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span>
    <span class="n">posterior_samples</span><span class="p">[</span><span class="s2">&quot;global_samples&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
    <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;maroon&quot;</span><span class="p">,</span>
    <span class="n">stat</span><span class="o">=</span><span class="s2">&quot;density&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span>
    <span class="n">test_sim</span><span class="p">[</span><span class="s2">&quot;hyper_prior_draws&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;True Value&quot;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Posterior Density over $\mu_{{pop}}$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/fd229cb26e1fc6545f01c90edd7f1b6b50ce7c7d66771cd0f45ae6370e9b3c05.png" src="../_images/fd229cb26e1fc6545f01c90edd7f1b6b50ce7c7d66771cd0f45ae6370e9b3c05.png" />
</div>
</div>
<p>At the local level:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_plots</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_plots</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span>
        <span class="n">posterior_samples</span><span class="p">[</span><span class="s2">&quot;local_samples&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
        <span class="n">bins</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
        <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;maroon&quot;</span><span class="p">,</span>
        <span class="n">stat</span><span class="o">=</span><span class="s2">&quot;density&quot;</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span>
        <span class="n">test_sim</span><span class="p">[</span><span class="s2">&quot;local_prior_draws&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span>
        <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">ymax</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;True Value&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Posterior Density for $\mu_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Sample Value&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Density&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/9df2a53927f2fd3179303d9ffedc96f2b2027ab6d726fbb677fd32fe51ca62f6.png" src="../_images/9df2a53927f2fd3179303d9ffedc96f2b2027ab6d726fbb677fd32fe51ca62f6.png" />
</div>
</div>
</section>
<section id="recoveries-in-the-aggregate">
<h3><a id='toc1_5_3_'></a> Recoveries in the Aggregate<a class="headerlink" href="#recoveries-in-the-aggregate" title="Link to this heading">#</a></h3>
<p>Here we check how well the model recovers parameters over a large population of simulated datasets.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N_EVAL_SIMS</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">N_EVAL_POSTERIOR_SAMPLES</span> <span class="o">=</span> <span class="mi">2_000</span>

<span class="n">eval_local_params</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">eval_local_posterior_samples</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">eval_global_params</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">eval_global_posterior_samples</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_EVAL_SIMS</span><span class="p">):</span>
    <span class="n">eval_sim</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">configurator</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">eval_posterior_samples</span> <span class="o">=</span> <span class="n">amortizer</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">eval_sim</span><span class="p">,</span> <span class="n">N_EVAL_POSTERIOR_SAMPLES</span><span class="p">)</span>

    <span class="n">eval_local_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eval_sim</span><span class="p">[</span><span class="s2">&quot;local_parameters&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">eval_local_posterior_samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">eval_posterior_samples</span><span class="p">[</span><span class="s2">&quot;local_samples&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="p">)</span>

    <span class="n">eval_global_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eval_sim</span><span class="p">[</span><span class="s2">&quot;hyper_parameters&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">eval_global_posterior_samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eval_posterior_samples</span><span class="p">[</span><span class="s2">&quot;global_samples&quot;</span><span class="p">])</span>

<span class="n">eval_local_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">eval_local_params</span><span class="p">))</span>
<span class="n">eval_local_posterior_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">eval_local_posterior_samples</span><span class="p">)</span>

<span class="n">eval_global_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">eval_global_params</span><span class="p">)</span>
<span class="n">eval_global_posterior_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">eval_global_posterior_samples</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Recovery at the population level:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">plot_recovery</span><span class="p">(</span>
    <span class="n">eval_global_posterior_samples</span><span class="p">,</span> <span class="n">eval_global_params</span><span class="p">,</span> <span class="n">param_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;$\mu_</span><span class="si">{pop}</span><span class="s2">$&quot;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/416289c6063363d5f4ef623bb4c6c8cc6600583df2f53328b2f6d7bd529b3aa9.png" src="../_images/416289c6063363d5f4ef623bb4c6c8cc6600583df2f53328b2f6d7bd529b3aa9.png" />
</div>
</div>
<p>Recovery at the group level:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">plot_recovery</span><span class="p">(</span>
    <span class="n">eval_local_posterior_samples</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">eval_local_params</span><span class="p">),</span>
    <span class="n">param_names</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;$\mu_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">$&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_GROUPS</span><span class="p">)],</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/45ee0736e390bf3ee28935b1ca1490db1dbdfe398419c8f929e0b3a85ff25258.png" src="../_images/45ee0736e390bf3ee28935b1ca1490db1dbdfe398419c8f929e0b3a85ff25258.png" />
</div>
</div>
</section>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-contents">Table of contents</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#two-level-priors"><a id="toc1_1_"></a>Two Level Priors</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#two-level-model"><a id="toc1_2_"></a>Two Level Model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#simulated-local-walks"><a id="toc1_2_1_"></a>Simulated Local Walks</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#networks-and-amortizer"><a id="toc1_3_"></a>Networks and Amortizer</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#summary-network"><a id="toc1_3_1_"></a>Summary Network</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#amortizers"><a id="toc1_3_2_"></a>Amortizers</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#training"><a id="toc1_4_"></a>Training</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#validation"><a id="toc1_5_"></a>Validation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#latent-dims"><a id="toc1_5_1_"></a>Latent Dims</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-calibration"><a id="calibration"></a>Checking Calibration</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parameter-recovery-in-example-dataset"><a id="toc1_5_2_"></a>Parameter Recovery in Example Dataset</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#recoveries-in-the-aggregate"><a id="toc1_5_3_"></a> Recoveries in the Aggregate</a></li>
</ul>
</li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  
  <div class="tocsection editthispage">
    <a href="https://github.com/bayesflow-org/bayesflow/edit/stable-legacy/docsrc/source/_examples/Two_Level_Sequential_Model.ipynb">
      <i class="fa-solid fa-pencil"></i>
      
      
        
          Edit on GitHub
        
      
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2023-2025, BayesFlow authors (lead maintainer: Stefan T. Radev).
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>